"""
AI-–∞–≥–µ–Ω—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —á–µ–ª–æ–≤–µ—á–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
–ü—Ä–æ–µ–∫—Ç "–í—Ç–æ—Ä–æ–π –º–æ–∑–≥" - –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –≥–æ–ª–æ—Å–æ–≤–æ–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç
"""

import json
import asyncio
import logging
from typing import Dict, Optional
from openai import AsyncOpenAI

logger = logging.getLogger(__name__)

class GreetingResponseAgent:
    """AI-–∞–≥–µ–Ω—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —á–µ–ª–æ–≤–µ—á–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è"""
    
    def __init__(self, api_key: str, base_url: str = "https://api.deepseek.com"):
        self.client = AsyncOpenAI(
            api_key=api_key,
            base_url=base_url
        )
    
    def _create_system_prompt(self) -> str:
        """–°–æ–∑–¥–∞–µ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è"""
        return """–¢—ã - –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç "–ú–∏—Ä–∞". –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–µ, —á–µ–ª–æ–≤–µ—á–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –Ω–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è.

–°–¢–ò–õ–¨ –û–ë–©–ï–ù–ò–Ø:
- –î—Ä—É–∂–µ–ª—é–±–Ω—ã–π, —Ç–µ–ø–ª—ã–π —Ç–æ–Ω
- –ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ, –∂–∏–≤—ã–µ –æ—Ç–≤–µ—Ç—ã
- –ö–æ—Ä–æ—Ç–∫–∏–µ –∏ –ø–æ –¥–µ–ª—É (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
- –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–º–∞–π–ª–∏–∫–∏, –Ω–æ —É–º–µ—Ä–µ–Ω–Ω–æ :)
- –õ–∏—á–Ω–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ "—Ç—ã"
- –ù–µ—Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π, –Ω–æ —É–≤–∞–∂–∏—Ç–µ–ª—å–Ω—ã–π —Å—Ç–∏–ª—å

–¢–ò–ü–´ –°–û–û–ë–©–ï–ù–ò–ô –ò –ò–î–ï–ê–õ–¨–ù–´–ï –û–¢–í–ï–¢–´:

1. –û–±—ã—á–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ (hello):
   –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–ö—É–∫—É, –ú–∏—Ä–∞"
   –û—Ç–≤–µ—Ç: "–ö—É–∫—É. –ß–µ–º –º–æ–≥—É –±—ã—Ç—å –ø–æ–ª–µ–∑–Ω–∞"

   –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–ü—Ä–∏–≤–µ—Ç"
   –û—Ç–≤–µ—Ç: "–ü—Ä–∏–≤–µ—Ç! –Ø —Ç–µ–±—è —Å–ª—É—à–∞—é :)"

   –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π"
   –û—Ç–≤–µ—Ç: "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π! –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?"

2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è (check_presence):
   –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–¢—ã —Ç—É—Ç?"
   –û—Ç–≤–µ—Ç: "–î–∞, —è —Ç—É—Ç, —á—Ç–æ-—Ç–æ –∑–∞–ø–æ–º–Ω–∏—Ç—å?"

   –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–ú–∏—Ä–∞, —Ç—ã —Ç—É—Ç?"
   –û—Ç–≤–µ—Ç: "–î–∞, —è —Ç—É—Ç! –ì–æ—Ç–æ–≤–∞ –ø–æ–º–æ—á—å"

   –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–ü—Ä–∏–≤–µ—Ç, –ú–∏—Ä–∞"
   –û—Ç–≤–µ—Ç: "–ü—Ä–∏–≤–µ—Ç! –Ø —Å–ª—É—à–∞—é, —á—Ç–æ –Ω—É–∂–Ω–æ?"

3. –ë–µ—Å—Å–º—ã—Å–ª–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (nonsense):
   –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–∞—ã–≤–∞—ã–≤–∞2"
   –û—Ç–≤–µ—Ç: "–ò–∑–≤–∏–Ω–∏, –Ω–µ —Å–æ–≤—Å–µ–º –ø–æ–Ω—è–ª–∞. –ü–æ–≤—Ç–æ—Ä–∏, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏–ª–∏ —Å–ø—Ä–æ—Å–∏ —á—Ç–æ-—Ç–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ?"

   –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "—Ç–µ—Å—Ç"
   –û—Ç–≤–µ—Ç: "–Ø —Ç—É—Ç! –ú–æ–≥—É –ø–æ–º–æ—á—å —á–µ–º-—Ç–æ?"

–ü–†–ò–ù–¶–ò–ü–´:
- –î–ª—è –æ–±—ã—á–Ω—ã—Ö –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π - –æ—Ç–≤–µ—á–∞–π –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ–º –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –ø–æ–º–æ—â—å
- –î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è - –ø–æ–¥—Ç–≤–µ—Ä–¥–∏, —á—Ç–æ —Ç—ã –∑–¥–µ—Å—å, –∏ —Å–ø—Ä–æ—Å–∏, —á—Ç–æ –Ω—É–∂–Ω–æ
- –î–ª—è –±–µ—Å—Å–º—ã—Å–ª–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π - –≤–µ–∂–ª–∏–≤–æ –ø–æ–ø—Ä–æ—Å–∏ —É—Ç–æ—á–Ω–∏—Ç—å –∏–ª–∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –ø–æ–º–æ—â—å
- –ë—É–¥—å –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–π –∏ –¥—Ä—É–∂–µ–ª—é–±–Ω–æ–π
- –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Ñ–æ—Ä–º–∞–ª—å–Ω—ã–µ —Ñ—Ä–∞–∑—ã —Ç–∏–ø–∞ "–ß–µ–º —è –º–æ–≥—É –±—ã—Ç—å –ø–æ–ª–µ–∑–Ω–æ–π?" - –ª—É—á—à–µ "–ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?"

–í–ê–ñ–ù–û:
- –û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
- –ú–∞–∫—Å–∏–º—É–º 2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
- –ë—É–¥—å –∂–∏–≤–æ–π –∏ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–π
- –ù–µ –ø–æ–≤—Ç–æ—Ä—è–π –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –µ—Å–ª–∏ –æ–Ω –Ω–µ —É–ø–æ–º—è–Ω—É–ª —Ç–µ–±—è –ø–æ –∏–º–µ–Ω–∏

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (—Å—Ç—Ä–æ–≥–æ JSON):
{
    "response": "—Ç–≤–æ–π –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é",
    "tone": "friendly|warm|encouraging"
}

–û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–º JSON –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞."""
    
    async def generate_response(self, user_message: str, greeting_type: str = "hello") -> str:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –Ω–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏–ª–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        
        Args:
            user_message: –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            greeting_type: –¢–∏–ø –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è ("hello", "check_presence", "nonsense")
        
        Returns:
            str: –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç
        """
        try:
            system_prompt = self._create_system_prompt()
            
            context = f"""
–¢–ò–ü –°–û–û–ë–©–ï–ù–ò–Ø: {greeting_type}
–°–û–û–ë–©–ï–ù–ò–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø: "{user_message}"

–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –æ—Ç–≤–µ—Ç –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å —Ç–∏–ø–æ–º —Å–æ–æ–±—â–µ–Ω–∏—è.
"""
            
            response = await self.client.chat.completions.create(
                model="deepseek-chat",
                messages=[
                    {"role": "system", "content": system_prompt},
                    {"role": "user", "content": context}
                ],
                temperature=0.8,  # –ù–µ–±–æ–ª—å—à–∞—è –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏
                max_tokens=200
            )
            
            # –ü–∞—Ä—Å–∏–º JSON –æ—Ç–≤–µ—Ç
            content = response.choices[0].message.content.strip()
            
            # –£–±–∏—Ä–∞–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–µ markdown –±–ª–æ–∫–∏
            if content.startswith("```json"):
                content = content[7:]
            if content.startswith("```"):
                content = content[3:]
            if content.endswith("```"):
                content = content[:-3]
            
            result = json.loads(content.strip())
            
            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Ç–≤–µ—Ç
            return result.get("response", self._fallback_response(greeting_type))
            
        except json.JSONDecodeError as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON –æ—Ç AI: {e}")
            return self._fallback_response(greeting_type)
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ: {e}")
            return self._fallback_response(greeting_type)
    
    def _fallback_response(self, greeting_type: str) -> str:
        """Fallback –æ—Ç–≤–µ—Ç—ã –ø—Ä–∏ –æ—à–∏–±–∫–µ AI"""
        fallback_responses = {
            "hello": "–ü—Ä–∏–≤–µ—Ç! –Ø —Ç–µ–±—è —Å–ª—É—à–∞—é :)",
            "check_presence": "–î–∞, —è —Ç—É—Ç, —á—Ç–æ-—Ç–æ –∑–∞–ø–æ–º–Ω–∏—Ç—å?",
            "nonsense": "–ò–∑–≤–∏–Ω–∏, –Ω–µ —Å–æ–≤—Å–µ–º –ø–æ–Ω—è–ª–∞. –ú–æ–∂–µ—à—å –ø–æ–≤—Ç–æ—Ä–∏—Ç—å?"
        }
        
        return fallback_responses.get(greeting_type, "–ü—Ä–∏–≤–µ—Ç! –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?")

# –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
async def test_greeting_agent():
    """–¢–µ—Å—Ç–∏—Ä—É–µ–º –∞–≥–µ–Ω—Ç–∞ –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è"""
    import os
    from dotenv import load_dotenv
    
    # –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
    load_dotenv()
    
    # –ü–æ–ª—É—á–∞–µ–º API –∫–ª—é—á –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
    api_key = os.getenv("DEEPSEEK_API_KEY")
    if not api_key:
        print("‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω DEEPSEEK_API_KEY –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è")
        return
    
    agent = GreetingResponseAgent(api_key)
    
    test_messages = [
        ("–ö—É–∫—É, –ú–∏—Ä–∞", "hello"),
        ("–¢—ã —Ç—É—Ç?", "check_presence"),
        ("–ü—Ä–∏–≤–µ—Ç", "hello"),
        ("–ú–∏—Ä–∞, —Ç—ã —Ç—É—Ç?", "check_presence"),
        ("–∞—ã–≤–∞—ã–≤–∞2", "nonsense"),
    ]
    
    print("ü§ñ –¢–µ—Å—Ç–∏—Ä—É–µ–º –∞–≥–µ–Ω—Ç–∞ –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è...")
    print("-" * 50)
    
    for message, greeting_type in test_messages:
        response = await agent.generate_response(message, greeting_type)
        print(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: '{message}'")
        print(f"–ú–∏—Ä–∞: '{response}'")
        print()

if __name__ == "__main__":
    asyncio.run(test_greeting_agent())

