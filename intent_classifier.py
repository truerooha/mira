"""
AI-Ð°Ð³ÐµÐ½Ñ‚ Ð´Ð»Ñ ÐºÐ»Ð°ÑÑÐ¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ð¸ Ð½Ð°Ð¼ÐµÑ€ÐµÐ½Ð¸Ð¹ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
ÐŸÑ€Ð¾ÐµÐºÑ‚ "Ð’Ñ‚Ð¾Ñ€Ð¾Ð¹ Ð¼Ð¾Ð·Ð³" - Ð¿ÐµÑ€ÑÐ¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ð³Ð¾Ð»Ð¾ÑÐ¾Ð²Ð¾Ð¹ Ð¸Ð½Ñ‚ÐµÐ»Ð»ÐµÐºÑ‚
"""

import json
import asyncio
import logging
from typing import Dict, List, Optional, Tuple
from enum import Enum
from openai import AsyncOpenAI

logger = logging.getLogger(__name__)

class IntentType(Enum):
    """Ð¢Ð¸Ð¿Ñ‹ Ð½Ð°Ð¼ÐµÑ€ÐµÐ½Ð¸Ð¹ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ"""
    SAVE_INFO = "save_info"          # Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ
    SEARCH_INFO = "search_info"      # ÐŸÐ¾Ð¸ÑÐº Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸
    SHOW_STATS = "show_stats"        # ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÑƒ
    SHOW_INSIGHTS = "show_insights"  # ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð¸Ð½ÑÐ°Ð¹Ñ‚Ñ‹
    SHOW_REMINDERS = "show_reminders" # ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð½Ð°Ð¿Ð¾Ð¼Ð¸Ð½Ð°Ð½Ð¸Ñ
    UNKNOWN = "unknown"              # ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð¾Ðµ Ð½Ð°Ð¼ÐµÑ€ÐµÐ½Ð¸Ðµ

class IntentClassifier:
    """AI-Ð°Ð³ÐµÐ½Ñ‚ Ð´Ð»Ñ ÐºÐ»Ð°ÑÑÐ¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ð¸ Ð½Ð°Ð¼ÐµÑ€ÐµÐ½Ð¸Ð¹ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ"""
    
    def __init__(self, api_key: str, base_url: str = "https://api.deepseek.com"):
        self.client = AsyncOpenAI(
            api_key=api_key,
            base_url=base_url
        )
    
    def _create_system_prompt(self) -> str:
        """Ð¡Ð¾Ð·Ð´Ð°ÐµÑ‚ ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ð¹ Ð¿Ñ€Ð¾Ð¼Ð¿Ñ‚ Ð´Ð»Ñ AI-Ð°Ð³ÐµÐ½Ñ‚Ð°"""
        return """Ð¢Ñ‹ - ÑƒÐ¼Ð½Ñ‹Ð¹ Ð°ÑÑÐ¸ÑÑ‚ÐµÐ½Ñ‚ Ð´Ð»Ñ ÐºÐ»Ð°ÑÑÐ¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ð¸ Ð½Ð°Ð¼ÐµÑ€ÐµÐ½Ð¸Ð¹ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð² Ð¿ÐµÑ€ÑÐ¾Ð½Ð°Ð»ÑŒÐ½Ð¾Ð¼ Ð±Ð¾Ñ‚Ðµ "Ð’Ñ‚Ð¾Ñ€Ð¾Ð¹ Ð¼Ð¾Ð·Ð³".

Ð¢Ð’ÐžÐ¯ Ð—ÐÐ”ÐÐ§Ð: ÐŸÑ€Ð¾Ð°Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð¸ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»Ð¸Ñ‚ÑŒ ÐµÐ³Ð¾ Ð½Ð°Ð¼ÐµÑ€ÐµÐ½Ð¸Ðµ.

Ð¢Ð˜ÐŸÐ« ÐÐÐœÐ•Ð Ð•ÐÐ˜Ð™:
1. "save_info" - Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ñ…Ð¾Ñ‡ÐµÑ‚ ÑÐ¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ Ð½Ð¾Ð²ÑƒÑŽ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ (Ð¿Ð¾Ð²ÐµÑÑ‚Ð²Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ, Ñ„Ð°ÐºÑ‚Ñ‹, ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ñ)
2. "search_info" - Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ñ…Ð¾Ñ‡ÐµÑ‚ Ð½Ð°Ð¹Ñ‚Ð¸ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ (Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹, Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹ Ð½Ð° Ð¿Ð¾Ð¸ÑÐº)
3. "show_stats" - Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ñ…Ð¾Ñ‡ÐµÑ‚ ÑƒÐ²Ð¸Ð´ÐµÑ‚ÑŒ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÑƒ ÑÐ²Ð¾Ð¸Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…
4. "show_insights" - Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ñ…Ð¾Ñ‡ÐµÑ‚ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð¸Ð½ÑÐ°Ð¹Ñ‚Ñ‹ Ð¸ Ð°Ð½Ð°Ð»Ð¸Ð·
5. "show_reminders" - Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ñ…Ð¾Ñ‡ÐµÑ‚ ÑƒÐ²Ð¸Ð´ÐµÑ‚ÑŒ Ð½Ð°Ð¿Ð¾Ð¼Ð¸Ð½Ð°Ð½Ð¸Ñ

ÐŸÐ Ð˜ÐœÐ•Ð Ð«:

Ð¡ÐžÐ¥Ð ÐÐÐ•ÐÐ˜Ð• Ð˜ÐÐ¤ÐžÐ ÐœÐÐ¦Ð˜Ð˜ (save_info):
- "Ð¡ÐµÐ³Ð¾Ð´Ð½Ñ Ñ Ð²ÑÑ‚Ñ€ÐµÑ‚Ð¸Ð» Ð›Ð¸Ð²Ð°Ð½Ð°"
- "Ð’ÑÑ‚Ñ€ÐµÑ‚Ð¸Ð» Ð’Ð°ÑÑŽ Ð² Ð°Ð²Ñ‚Ð¾ÑÐµÑ€Ð²Ð¸ÑÐµ"
- "ÐšÑƒÐ¿Ð¸Ð» Ð¼Ð¾Ð»Ð¾ÐºÐ¾ Ð·Ð° 50 Ñ€ÑƒÐ±Ð»ÐµÐ¹"
- "ÐœÐ¾Ð¹ Ð²ÐµÑ 75 ÐºÐ³"
- "Ð‘Ð¾Ð»Ð¸Ñ‚ Ð³Ð¾Ð»Ð¾Ð²Ð°, Ð¿Ñ€Ð¸Ð½ÑÐ» Ñ‚Ð°Ð±Ð»ÐµÑ‚ÐºÑƒ"
- "ÐÐ°Ð¿Ð¾Ð¼Ð½Ð¸ ÐºÑƒÐ¿Ð¸Ñ‚ÑŒ Ñ…Ð»ÐµÐ± Ð·Ð°Ð²Ñ‚Ñ€Ð°"

ÐŸÐžÐ˜Ð¡Ðš Ð˜ÐÐ¤ÐžÐ ÐœÐÐ¦Ð˜Ð˜ (search_info):
- "ÐšÐ¾Ð³Ð¾ Ñ Ð²ÑÑ‚Ñ€ÐµÑ‚Ð¸Ð» ÑÐµÐ³Ð¾Ð´Ð½Ñ?" (Ñ Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¼ Ð·Ð½Ð°ÐºÐ¾Ð¼)
- "ÐšÐ¾Ð³Ð¾ Ñ Ð²ÑÑ‚Ñ€ÐµÑ‚Ð¸Ð» ÑÐµÐ³Ð¾Ð´Ð½Ñ" (Ð±ÐµÐ· Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ð³Ð¾ Ð·Ð½Ð°ÐºÐ°, Ð½Ð¾ ÑÑ‚Ð¾ Ð²Ð¾Ð¿Ñ€Ð¾Ñ)
- "Ð§Ñ‚Ð¾ Ñ Ð·Ð½Ð°ÑŽ Ð¾ Ð’Ð°ÑÐµ?"
- "Ð“Ð´Ðµ Ñ Ð±Ñ‹Ð» Ð²Ñ‡ÐµÑ€Ð°?"
- "Ð¡ÐºÐ¾Ð»ÑŒÐºÐ¾ Ñ Ð¿Ð¾Ñ‚Ñ€Ð°Ñ‚Ð¸Ð» Ð½Ð° ÐµÐ´Ñƒ?"
- "Ð Ð°ÑÑÐºÐ°Ð¶Ð¸ Ð¾ Ð¼Ð¾Ð¸Ñ… Ð²ÑÑ‚Ñ€ÐµÑ‡Ð°Ñ…"
- "ÐŸÐ¾ÐºÐ°Ð¶Ð¸ Ñ‡Ñ‚Ð¾ Ñƒ Ð¼ÐµÐ½Ñ ÐµÑÑ‚ÑŒ Ð¿Ñ€Ð¾ Ñ€Ð°Ð±Ð¾Ñ‚Ñƒ"
- "ÐºÐ¾Ð³Ð¾ Ñ Ð²ÑÑ‚Ñ€ÐµÑ‚Ð¸Ð» ÑÐµÐ³Ð¾Ð´Ð½Ñ Ð·Ð° Ð²ÐµÑÑŒ Ð´ÐµÐ½ÑŒ" (Ð²Ð¾Ð¿Ñ€Ð¾Ñ Ð±ÐµÐ· Ð·Ð½Ð°ÐºÐ° Ð¿Ñ€ÐµÐ¿Ð¸Ð½Ð°Ð½Ð¸Ñ)

Ð¡Ð¢ÐÐ¢Ð˜Ð¡Ð¢Ð˜ÐšÐ (show_stats):
- "Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ°"
- "ÐŸÐ¾ÐºÐ°Ð¶Ð¸ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÑƒ"
- "ÐœÐ¾Ñ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ°"

Ð’ÐÐ–ÐÐž: "Ð¡ÐºÐ¾Ð»ÑŒÐºÐ¾ Ñƒ Ð¼ÐµÐ½Ñ Ð·Ð°Ð¿Ð¸ÑÐµÐ¹?" = search_info (ÑÑ‚Ð¾ Ð²Ð¾Ð¿Ñ€Ð¾Ñ, Ð° Ð½Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ð° ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸)

Ð˜ÐÐ¡ÐÐ™Ð¢Ð« (show_insights):
- "Ð˜Ð½ÑÐ°Ð¹Ñ‚Ñ‹"
- "Ð§Ñ‚Ð¾ Ð¸Ð½Ñ‚ÐµÑ€ÐµÑÐ½Ð¾Ð³Ð¾?"
- "ÐÐ½Ð°Ð»Ð¸Ð· Ð¼Ð¾Ð¸Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…"

ÐÐÐŸÐžÐœÐ˜ÐÐÐÐ˜Ð¯ (show_reminders):
- "ÐÐ°Ð¿Ð¾Ð¼Ð¸Ð½Ð°Ð½Ð¸Ñ"
- "Ð§Ñ‚Ð¾ Ð½Ð°Ð´Ð¾ ÑÐ´ÐµÐ»Ð°Ñ‚ÑŒ?"
- "ÐŸÐ¾ÐºÐ°Ð¶Ð¸ Ð½Ð°Ð¿Ð¾Ð¼Ð¸Ð½Ð°Ð½Ð¸Ñ"

Ð’ÐÐ–ÐÐž:
- Ð’Ð¾Ð¿Ñ€Ð¾ÑÑ‹ (Ñ "?" Ð¸Ð»Ð¸ Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¼Ð¸ ÑÐ»Ð¾Ð²Ð°Ð¼Ð¸) = search_info
- Ð’Ð¾Ð¿Ñ€Ð¾ÑÑ‹ Ð‘Ð•Ð— "?" Ð½Ð¾ Ñ Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¼Ð¸ ÑÐ»Ð¾Ð²Ð°Ð¼Ð¸ = search_info
- ÐŸÐ¾Ð²ÐµÑÑ‚Ð²Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ Ñ Ñ„Ð°ÐºÑ‚Ð°Ð¼Ð¸ = save_info
- ÐšÐ¾Ð¼Ð°Ð½Ð´Ñ‹ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸/Ð¸Ð½ÑÐ°Ð¹Ñ‚Ð¾Ð²/Ð½Ð°Ð¿Ð¾Ð¼Ð¸Ð½Ð°Ð½Ð¸Ð¹ = ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ð¹ Ñ‚Ð¸Ð¿
- Ð•ÑÐ»Ð¸ ÑÐ¾Ð¼Ð½ÐµÐ²Ð°ÐµÑˆÑŒÑÑ Ð¼ÐµÐ¶Ð´Ñƒ save_info Ð¸ search_info, Ð²Ñ‹Ð±Ð¸Ñ€Ð°Ð¹ search_info Ð´Ð»Ñ Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ¾Ð²

Ð’ÐžÐŸÐ ÐžÐ¡Ð˜Ð¢Ð•Ð›Ð¬ÐÐ«Ð• Ð¡Ð›ÐžÐ’Ð (Ð²ÑÐµÐ³Ð´Ð° search_info):
- ÐºÑ‚Ð¾, ÐºÐ¾Ð³Ð¾, ÐºÐ¾Ð¼Ñƒ, ÐºÐµÐ¼
- Ñ‡Ñ‚Ð¾, Ñ‡ÐµÐ³Ð¾, Ñ‡ÐµÐ¼Ñƒ, Ñ‡ÐµÐ¼
- Ð³Ð´Ðµ, ÐºÑƒÐ´Ð°, Ð¾Ñ‚ÐºÑƒÐ´Ð°
- ÐºÐ¾Ð³Ð´Ð°, Ð²Ð¾ ÑÐºÐ¾Ð»ÑŒÐºÐ¾
- ÐºÐ°Ðº, ÐºÐ°ÐºÐ¸Ð¼ Ð¾Ð±Ñ€Ð°Ð·Ð¾Ð¼
- Ð¿Ð¾Ñ‡ÐµÐ¼Ñƒ, Ð·Ð°Ñ‡ÐµÐ¼, Ð¾Ñ‚Ñ‡ÐµÐ³Ð¾
- ÑÐºÐ¾Ð»ÑŒÐºÐ¾, ÐºÐ°ÐºÐ¾Ð¹, ÐºÐ°ÐºÐ°Ñ, ÐºÐ°ÐºÐ¸Ðµ
- ÐµÑÑ‚ÑŒ Ð»Ð¸, ÐµÑÑ‚ÑŒ Ñƒ Ð¼ÐµÐ½Ñ, Ð·Ð½Ð°ÐµÑˆÑŒ Ð»Ð¸

ÐŸÐ Ð˜ÐœÐ•Ð Ð« Ð’ÐžÐŸÐ ÐžÐ¡ÐžÐ’ Ð‘Ð•Ð— "?":
- "ÐºÐ¾Ð³Ð¾ Ñ Ð²ÑÑ‚Ñ€ÐµÑ‚Ð¸Ð» ÑÐµÐ³Ð¾Ð´Ð½Ñ" = search_info
- "Ñ‡Ñ‚Ð¾ Ñ Ð·Ð½Ð°ÑŽ Ð¾ Ð²Ð°ÑÐµ" = search_info
- "Ð³Ð´Ðµ Ñ Ð±Ñ‹Ð» Ð²Ñ‡ÐµÑ€Ð°" = search_info
- "ÑÐºÐ¾Ð»ÑŒÐºÐ¾ Ñƒ Ð¼ÐµÐ½Ñ Ð·Ð°Ð¿Ð¸ÑÐµÐ¹" = search_info

Ð¤ÐžÐ ÐœÐÐ¢ ÐžÐ¢Ð’Ð•Ð¢Ð (ÑÑ‚Ñ€Ð¾Ð³Ð¾ JSON):
{
    "intent": "save_info|search_info|show_stats|show_insights|show_reminders",
    "confidence": 0.9,
    "topic": "Ð¾ÑÐ½Ð¾Ð²Ð½Ð°Ñ Ñ‚ÐµÐ¼Ð° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ",
    "info_type": "person|place|object|event|health|finance|work|general",
    "question_type": "person|object|place|time|method|reason|quantity|general"
}

ÐžÑ‚Ð²ÐµÑ‡Ð°Ð¹ Ð¢ÐžÐ›Ð¬ÐšÐž Ð²Ð°Ð»Ð¸Ð´Ð½Ñ‹Ð¼ JSON Ð±ÐµÐ· Ð´Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ð³Ð¾ Ñ‚ÐµÐºÑÑ‚Ð°."""
    
    async def classify_intent(self, text: str) -> Tuple[IntentType, Dict]:
        """
        ÐšÐ»Ð°ÑÑÐ¸Ñ„Ð¸Ñ†Ð¸Ñ€ÑƒÐµÑ‚ Ð½Ð°Ð¼ÐµÑ€ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒÑŽ AI
        
        Returns:
            Tuple[IntentType, Dict]: (Ñ‚Ð¸Ð¿ Ð½Ð°Ð¼ÐµÑ€ÐµÐ½Ð¸Ñ, Ð´Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð°Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ)
        """
        try:
            system_prompt = self._create_system_prompt()
            
            response = await self.client.chat.completions.create(
                model="deepseek-chat",
                messages=[
                    {"role": "system", "content": system_prompt},
                    {"role": "user", "content": f"ÐŸÑ€Ð¾Ð°Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐ¹ ÑÑ‚Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ: {text}"}
                ],
                temperature=0.1,  # ÐÐ¸Ð·ÐºÐ°Ñ Ñ‚ÐµÐ¼Ð¿ÐµÑ€Ð°Ñ‚ÑƒÑ€Ð° Ð´Ð»Ñ ÑÑ‚Ð°Ð±Ð¸Ð»ÑŒÐ½Ð¾ÑÑ‚Ð¸
                max_tokens=500
            )
            
            # ÐŸÐ°Ñ€ÑÐ¸Ð¼ JSON Ð¾Ñ‚Ð²ÐµÑ‚
            content = response.choices[0].message.content.strip()
            
            # Ð£Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ñ‹Ðµ markdown Ð±Ð»Ð¾ÐºÐ¸
            if content.startswith("```json"):
                content = content[7:]
            if content.endswith("```"):
                content = content[:-3]
            
            result = json.loads(content)
            
            # Ð’Ð°Ð»Ð¸Ð´Ð¸Ñ€ÑƒÐµÐ¼ Ð¸ Ð¿Ñ€ÐµÐ¾Ð±Ñ€Ð°Ð·ÑƒÐµÐ¼ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚
            return self._validate_result(result, text)
            
        except json.JSONDecodeError as e:
            logger.error(f"ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð°Ñ€ÑÐ¸Ð½Ð³Ð° JSON Ð¾Ñ‚ AI: {e}")
            return self._fallback_classification(text)
        except Exception as e:
            logger.error(f"ÐžÑˆÐ¸Ð±ÐºÐ° AI ÐºÐ»Ð°ÑÑÐ¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ð¸: {e}")
            return self._fallback_classification(text)
    
    def _validate_result(self, result: Dict, original_text: str) -> Tuple[IntentType, Dict]:
        """Ð’Ð°Ð»Ð¸Ð´Ð¸Ñ€ÑƒÐµÑ‚ Ð¸ Ð¿Ñ€ÐµÐ¾Ð±Ñ€Ð°Ð·ÑƒÐµÑ‚ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ AI"""
        try:
            # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ñ‚Ð¸Ð¿ Ð½Ð°Ð¼ÐµÑ€ÐµÐ½Ð¸Ñ
            intent_str = result.get("intent", "save_info")
            intent_type = IntentType(intent_str)
            
            # Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ Ð´Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½ÑƒÑŽ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ
            info = {
                "original_text": original_text,
                "confidence": result.get("confidence", 0.8),
                "topic": result.get("topic", ""),
                "info_type": result.get("info_type", "general"),
                "question_type": result.get("question_type", "general")
            }
            
            return intent_type, info
            
        except ValueError:
            logger.error(f"ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ð¹ Ñ‚Ð¸Ð¿ Ð½Ð°Ð¼ÐµÑ€ÐµÐ½Ð¸Ñ: {result.get('intent')}")
            return IntentType.UNKNOWN, {"original_text": original_text}
    
    def _fallback_classification(self, text: str) -> Tuple[IntentType, Dict]:
        """Fallback ÐºÐ»Ð°ÑÑÐ¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ñ Ð¿Ñ€Ð¸ Ð¾ÑˆÐ¸Ð±ÐºÐµ AI"""
        text_lower = text.lower().strip()
        
        # ÐŸÑ€Ð¾ÑÑ‚Ð°Ñ ÑÐ²Ñ€Ð¸ÑÑ‚Ð¸ÐºÐ°
        if any(word in text_lower for word in ["ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ°", "stats"]):
            return IntentType.SHOW_STATS, {"original_text": text}
        elif any(word in text_lower for word in ["Ð¸Ð½ÑÐ°Ð¹Ñ‚Ñ‹", "insights"]):
            return IntentType.SHOW_INSIGHTS, {"original_text": text}
        elif any(word in text_lower for word in ["Ð½Ð°Ð¿Ð¾Ð¼Ð¸Ð½Ð°Ð½Ð¸Ñ", "reminders"]):
            return IntentType.SHOW_REMINDERS, {"original_text": text}
        elif ("?" in text or 
              any(word in text_lower for word in ["ÐºÑ‚Ð¾", "ÐºÐ¾Ð³Ð¾", "ÐºÐ¾Ð¼Ñƒ", "ÐºÐµÐ¼", "Ñ‡Ñ‚Ð¾", "Ñ‡ÐµÐ³Ð¾", "Ñ‡ÐµÐ¼Ñƒ", "Ñ‡ÐµÐ¼", 
                                                  "Ð³Ð´Ðµ", "ÐºÑƒÐ´Ð°", "Ð¾Ñ‚ÐºÑƒÐ´Ð°", "ÐºÐ¾Ð³Ð´Ð°", "Ð²Ð¾ ÑÐºÐ¾Ð»ÑŒÐºÐ¾", "ÐºÐ°Ðº", 
                                                  "Ð¿Ð¾Ñ‡ÐµÐ¼Ñƒ", "Ð·Ð°Ñ‡ÐµÐ¼", "Ð¾Ñ‚Ñ‡ÐµÐ³Ð¾", "ÑÐºÐ¾Ð»ÑŒÐºÐ¾", "ÐºÐ°ÐºÐ¾Ð¹", "ÐºÐ°ÐºÐ°Ñ", "ÐºÐ°ÐºÐ¸Ðµ",
                                                  "Ñ€Ð°ÑÑÐºÐ°Ð¶Ð¸", "Ð¿Ð¾ÐºÐ°Ð¶Ð¸", "ÐµÑÑ‚ÑŒ Ð»Ð¸", "ÐµÑÑ‚ÑŒ Ñƒ Ð¼ÐµÐ½Ñ", "Ð·Ð½Ð°ÐµÑˆÑŒ Ð»Ð¸"])):
            return IntentType.SEARCH_INFO, {"original_text": text, "topic": text}
        else:
            return IntentType.SAVE_INFO, {"original_text": text, "info_type": "general"}
    

# ÐŸÑ€Ð¸Ð¼ÐµÑ€ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ
async def test_intent_classifier():
    """Ð¢ÐµÑÑ‚Ð¸Ñ€ÑƒÐµÐ¼ AI-ÐºÐ»Ð°ÑÑÐ¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ñ€ Ð½Ð°Ð¼ÐµÑ€ÐµÐ½Ð¸Ð¹"""
    import os
    from dotenv import load_dotenv
    
    # Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
    load_dotenv()
    
    # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ API ÐºÐ»ÑŽÑ‡ Ð¸Ð· Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
    api_key = os.getenv("DEEPSEEK_API_KEY")
    if not api_key:
        print("âŒ ÐÐµ Ð½Ð°Ð¹Ð´ÐµÐ½ DEEPSEEK_API_KEY Ð² Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ")
        return
    
    classifier = IntentClassifier(api_key)
    
    test_messages = [
        "ÐšÐ¾Ð³Ð¾ Ñ Ð²ÑÑ‚Ñ€ÐµÑ‚Ð¸Ð» ÑÐµÐ³Ð¾Ð´Ð½Ñ?",
        "ÐºÐ¾Ð³Ð¾ Ñ Ð²ÑÑ‚Ñ€ÐµÑ‚Ð¸Ð» ÑÐµÐ³Ð¾Ð´Ð½Ñ Ð·Ð° Ð²ÐµÑÑŒ Ð´ÐµÐ½ÑŒ",  # ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð½Ñ‹Ð¹ ÑÐ»ÑƒÑ‡Ð°Ð¹ Ð±ÐµÐ· "?"
        "Ð§Ñ‚Ð¾ Ñ Ð·Ð½Ð°ÑŽ Ð¾ Ð’Ð°ÑÐµ?",
        "Ñ‡Ñ‚Ð¾ Ñ Ð·Ð½Ð°ÑŽ Ð¾ Ð²Ð°ÑÐµ",  # Ð‘ÐµÐ· "?"
        "Ð¡ÐµÐ³Ð¾Ð´Ð½Ñ Ñ Ð²ÑÑ‚Ñ€ÐµÑ‚Ð¸Ð» Ð›Ð¸Ð²Ð°Ð½Ð°",
        "Ð’ÑÑ‚Ñ€ÐµÑ‚Ð¸Ð» Ð’Ð°ÑÑŽ Ð² Ð°Ð²Ñ‚Ð¾ÑÐµÑ€Ð²Ð¸ÑÐµ",
        "Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ°",
        "Ð˜Ð½ÑÐ°Ð¹Ñ‚Ñ‹",
        "ÐÐ°Ð¿Ð¾Ð¼Ð¸Ð½Ð°Ð½Ð¸Ñ",
        "Ð¡ÐºÐ¾Ð»ÑŒÐºÐ¾ Ñƒ Ð¼ÐµÐ½Ñ Ð·Ð°Ð¿Ð¸ÑÐµÐ¹?",
        "ÑÐºÐ¾Ð»ÑŒÐºÐ¾ Ñƒ Ð¼ÐµÐ½Ñ Ð·Ð°Ð¿Ð¸ÑÐµÐ¹",  # Ð‘ÐµÐ· "?"
        "ÐŸÐ¾ÐºÐ°Ð¶Ð¸ Ñ‡Ñ‚Ð¾ Ñƒ Ð¼ÐµÐ½Ñ ÐµÑÑ‚ÑŒ Ð¿Ñ€Ð¾ Ñ€Ð°Ð±Ð¾Ñ‚Ñƒ"
    ]
    
    print("ðŸ¤– Ð¢ÐµÑÑ‚Ð¸Ñ€ÑƒÐµÐ¼ AI-ÐºÐ»Ð°ÑÑÐ¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ñ€ Ð½Ð°Ð¼ÐµÑ€ÐµÐ½Ð¸Ð¹...")
    print("-" * 50)
    
    for message in test_messages:
        intent, info = await classifier.classify_intent(message)
        print(f"'{message}' -> {intent.value}: {info}")

if __name__ == "__main__":
    asyncio.run(test_intent_classifier())
