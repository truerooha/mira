"""
AI-–∞–≥–µ–Ω—Ç –¥–ª—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –Ω–∞–º–µ—Ä–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
–ü—Ä–æ–µ–∫—Ç "–í—Ç–æ—Ä–æ–π –º–æ–∑–≥" - –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –≥–æ–ª–æ—Å–æ–≤–æ–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç
"""

import json
import asyncio
import logging
from typing import Dict, List, Optional, Tuple
from enum import Enum
from openai import AsyncOpenAI

logger = logging.getLogger(__name__)

class IntentType(Enum):
    """–¢–∏–ø—ã –Ω–∞–º–µ—Ä–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    SAVE_INFO = "save_info"          # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
    SEARCH_INFO = "search_info"      # –ü–æ–∏—Å–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
    SHOW_STATS = "show_stats"        # –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    SHOW_INSIGHTS = "show_insights"  # –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Å–∞–π—Ç—ã
    SHOW_REMINDERS = "show_reminders" # –ü–æ–∫–∞–∑–∞—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
    GREETING = "greeting"            # –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏–ª–∏ –±–µ—Å—Å–º—ã—Å–ª–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    UNKNOWN = "unknown"              # –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –Ω–∞–º–µ—Ä–µ–Ω–∏–µ

class IntentClassifier:
    """AI-–∞–≥–µ–Ω—Ç –¥–ª—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –Ω–∞–º–µ—Ä–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    
    def __init__(self, api_key: str, base_url: str = "https://api.deepseek.com"):
        self.client = AsyncOpenAI(
            api_key=api_key,
            base_url=base_url
        )
    
    def _create_system_prompt(self) -> str:
        """–°–æ–∑–¥–∞–µ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è AI-–∞–≥–µ–Ω—Ç–∞"""
        return """–¢—ã - —É–º–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –Ω–∞–º–µ—Ä–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–º –±–æ—Ç–µ "–í—Ç–æ—Ä–æ–π –º–æ–∑–≥".

–¢–í–û–Ø –ó–ê–î–ê–ß–ê: –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –µ–≥–æ –Ω–∞–º–µ—Ä–µ–Ω–∏–µ.

–¢–ò–ü–´ –ù–ê–ú–ï–†–ï–ù–ò–ô:
1. "save_info" - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–æ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é (–ø–æ–≤–µ—Å—Ç–≤–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, —Ñ–∞–∫—Ç—ã, —Å–æ–±—ã—Ç–∏—è)
2. "search_info" - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç –Ω–∞–π—Ç–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é (–≤–æ–ø—Ä–æ—Å—ã, –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –ø–æ–∏—Å–∫)
3. "show_stats" - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç —É–≤–∏–¥–µ—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å–≤–æ–∏—Ö –¥–∞–Ω–Ω—ã—Ö
4. "show_insights" - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Å–∞–π—Ç—ã –∏ –∞–Ω–∞–ª–∏–∑
5. "show_reminders" - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç —É–≤–∏–¥–µ—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
6. "greeting" - –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ, –±–µ—Å—Å–º—ã—Å–ª–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è –±–æ—Ç–∞ (–ù–ï —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –≤ –±–∞–∑—É!)

–ü–†–ò–ú–ï–†–´:

–°–û–•–†–ê–ù–ï–ù–ò–ï –ò–ù–§–û–†–ú–ê–¶–ò–ò (save_info):
- "–°–µ–≥–æ–¥–Ω—è —è –≤—Å—Ç—Ä–µ—Ç–∏–ª –õ–∏–≤–∞–Ω–∞"
- "–í—Å—Ç—Ä–µ—Ç–∏–ª –í–∞—Å—é –≤ –∞–≤—Ç–æ—Å–µ—Ä–≤–∏—Å–µ"
- "–ö—É–ø–∏–ª –º–æ–ª–æ–∫–æ –∑–∞ 50 —Ä—É–±–ª–µ–π"
- "–ú–æ–π –≤–µ—Å 75 –∫–≥"
- "–ë–æ–ª–∏—Ç –≥–æ–ª–æ–≤–∞, –ø—Ä–∏–Ω—è–ª —Ç–∞–±–ª–µ—Ç–∫—É"
- "–ù–∞–ø–æ–º–Ω–∏ –∫—É–ø–∏—Ç—å —Ö–ª–µ–± –∑–∞–≤—Ç—Ä–∞"

–ü–û–ò–°–ö –ò–ù–§–û–†–ú–ê–¶–ò–ò (search_info):
- "–ö–æ–≥–æ —è –≤—Å—Ç—Ä–µ—Ç–∏–ª —Å–µ–≥–æ–¥–Ω—è?" (—Å –≤–æ–ø—Ä–æ—Å–∏—Ç–µ–ª—å–Ω—ã–º –∑–Ω–∞–∫–æ–º)
- "–ö–æ–≥–æ —è –≤—Å—Ç—Ä–µ—Ç–∏–ª —Å–µ–≥–æ–¥–Ω—è" (–±–µ–∑ –≤–æ–ø—Ä–æ—Å–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∑–Ω–∞–∫–∞, –Ω–æ —ç—Ç–æ –≤–æ–ø—Ä–æ—Å)
- "–ß—Ç–æ —è –∑–Ω–∞—é –æ –í–∞—Å–µ?"
- "–ì–¥–µ —è –±—ã–ª –≤—á–µ—Ä–∞?"
- "–°–∫–æ–ª—å–∫–æ —è –ø–æ—Ç—Ä–∞—Ç–∏–ª –Ω–∞ –µ–¥—É?"
- "–†–∞—Å—Å–∫–∞–∂–∏ –æ –º–æ–∏—Ö –≤—Å—Ç—Ä–µ—á–∞—Ö"
- "–ü–æ–∫–∞–∂–∏ —á—Ç–æ —É –º–µ–Ω—è –µ—Å—Ç—å –ø—Ä–æ —Ä–∞–±–æ—Ç—É"
- "–∫–æ–≥–æ —è –≤—Å—Ç—Ä–µ—Ç–∏–ª —Å–µ–≥–æ–¥–Ω—è –∑–∞ –≤–µ—Å—å –¥–µ–Ω—å" (–≤–æ–ø—Ä–æ—Å –±–µ–∑ –∑–Ω–∞–∫–∞ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è)

–°–¢–ê–¢–ò–°–¢–ò–ö–ê (show_stats):
- "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞"
- "–ü–æ–∫–∞–∂–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É"
- "–ú–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞"

–í–ê–ñ–ù–û: "–°–∫–æ–ª—å–∫–æ —É –º–µ–Ω—è –∑–∞–ø–∏—Å–µ–π?" = search_info (—ç—Ç–æ –≤–æ–ø—Ä–æ—Å, –∞ –Ω–µ –∫–æ–º–∞–Ω–¥–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏)

–ò–ù–°–ê–ô–¢–´ (show_insights):
- "–ò–Ω—Å–∞–π—Ç—ã"
- "–ß—Ç–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–≥–æ?"
- "–ê–Ω–∞–ª–∏–∑ –º–æ–∏—Ö –¥–∞–Ω–Ω—ã—Ö"

–ù–ê–ü–û–ú–ò–ù–ê–ù–ò–Ø (show_reminders):
- "–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è"
- "–ß—Ç–æ –Ω–∞–¥–æ —Å–¥–µ–ª–∞—Ç—å?"
- "–ü–æ–∫–∞–∂–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è"

–ü–†–ò–í–ï–¢–°–¢–í–ò–Ø –ò –ë–ï–°–°–ú–´–°–õ–ï–ù–ù–´–ï –°–û–û–ë–©–ï–ù–ò–Ø (greeting):
- "–ü—Ä–∏–≤–µ—Ç"
- "–ö—É–∫—É"
- "–ö—É–∫—É, –ú–∏—Ä–∞"
- "–¢—ã —Ç—É—Ç?"
- "–ú–∏—Ä–∞, —Ç—ã —Ç—É—Ç?"
- "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π"
- "–•–∞–π"
- "–∞—ã–≤–∞—ã–≤–∞2" (–±–µ—Å—Å–º—ã—Å–ª–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç)
- "—Ç–µ—Å—Ç" (–µ—Å–ª–∏ —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ –±–æ—Ç–∞, –Ω–µ —Ñ–∞–∫—Ç)
- –õ—é–±—ã–µ –∫–æ—Ä–æ—Ç–∫–∏–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –±–µ–∑ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è
- –°–æ–æ–±—â–µ–Ω–∏—è –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ —Å–æ–¥–µ—Ä–∂–∞—Ç —Ñ–∞–∫—Ç–æ–≤, —Å–æ–±—ã—Ç–∏–π, –≤–æ–ø—Ä–æ—Å–æ–≤ –∏–ª–∏ –∫–æ–º–∞–Ω–¥

–í–ê–ñ–ù–û –û GREETING:
- –≠—Ç–æ –ù–ï —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ - –Ω–µ –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å –≤ –±–∞–∑—É!
- –≠—Ç–æ –ø—Ä–æ—Å—Ç–æ –æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –±–æ—Ç–∞
- –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ (< 10 —Å–∏–º–≤–æ–ª–æ–≤) –∏ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ = greeting
- –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –±–µ–∑ —Ñ–∞–∫—Ç–æ–≤ = greeting
- –ï—Å–ª–∏ —ç—Ç–æ –Ω–∞–±–æ—Ä —Å–ª—É—á–∞–π–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤ –∏–ª–∏ –±–µ—Å—Å–º—ã—Å–ª–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç = greeting

–í–ê–ñ–ù–û:
- –í–æ–ø—Ä–æ—Å—ã (—Å "?" –∏–ª–∏ –≤–æ–ø—Ä–æ—Å–∏—Ç–µ–ª—å–Ω—ã–º–∏ —Å–ª–æ–≤–∞–º–∏) = search_info
- –í–æ–ø—Ä–æ—Å—ã –ë–ï–ó "?" –Ω–æ —Å –≤–æ–ø—Ä–æ—Å–∏—Ç–µ–ª—å–Ω—ã–º–∏ —Å–ª–æ–≤–∞–º–∏ = search_info
- –ü–æ–≤–µ—Å—Ç–≤–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —Å —Ñ–∞–∫—Ç–∞–º–∏ = save_info
- –ö–æ–º–∞–Ω–¥—ã —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏/–∏–Ω—Å–∞–π—Ç–æ–≤/–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π = —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —Ç–∏–ø
- –ï—Å–ª–∏ —Å–æ–º–Ω–µ–≤–∞–µ—à—å—Å—è –º–µ–∂–¥—É save_info –∏ search_info, –≤—ã–±–∏—Ä–∞–π search_info –¥–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤

–í–û–ü–†–û–°–ò–¢–ï–õ–¨–ù–´–ï –°–õ–û–í–ê (–≤—Å–µ–≥–¥–∞ search_info):
- –∫—Ç–æ, –∫–æ–≥–æ, –∫–æ–º—É, –∫–µ–º
- —á—Ç–æ, —á–µ–≥–æ, —á–µ–º—É, —á–µ–º
- –≥–¥–µ, –∫—É–¥–∞, –æ—Ç–∫—É–¥–∞
- –∫–æ–≥–¥–∞, –≤–æ —Å–∫–æ–ª—å–∫–æ
- –∫–∞–∫, –∫–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º
- –ø–æ—á–µ–º—É, –∑–∞—á–µ–º, –æ—Ç—á–µ–≥–æ
- —Å–∫–æ–ª—å–∫–æ, –∫–∞–∫–æ–π, –∫–∞–∫–∞—è, –∫–∞–∫–∏–µ
- –µ—Å—Ç—å –ª–∏, –µ—Å—Ç—å —É –º–µ–Ω—è, –∑–Ω–∞–µ—à—å –ª–∏

–ü–†–ò–ú–ï–†–´ –í–û–ü–†–û–°–û–í –ë–ï–ó "?":
- "–∫–æ–≥–æ —è –≤—Å—Ç—Ä–µ—Ç–∏–ª —Å–µ–≥–æ–¥–Ω—è" = search_info
- "—á—Ç–æ —è –∑–Ω–∞—é –æ –≤–∞—Å–µ" = search_info
- "–≥–¥–µ —è –±—ã–ª –≤—á–µ—Ä–∞" = search_info
- "—Å–∫–æ–ª—å–∫–æ —É –º–µ–Ω—è –∑–∞–ø–∏—Å–µ–π" = search_info

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (—Å—Ç—Ä–æ–≥–æ JSON):
{
    "intent": "save_info|search_info|show_stats|show_insights|show_reminders|greeting",
    "confidence": 0.9,
    "topic": "–æ—Å–Ω–æ–≤–Ω–∞—è —Ç–µ–º–∞ —Å–æ–æ–±—â–µ–Ω–∏—è",
    "info_type": "person|place|object|event|health|finance|work|general",
    "question_type": "person|object|place|time|method|reason|quantity|general",
    "greeting_type": "hello|check_presence|nonsense"
}

–û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–º JSON –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞."""
    
    async def classify_intent(self, text: str) -> Tuple[IntentType, Dict]:
        """
        –ö–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç –Ω–∞–º–µ—Ä–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –ø–æ–º–æ—â—å—é AI
        
        Returns:
            Tuple[IntentType, Dict]: (—Ç–∏–ø –Ω–∞–º–µ—Ä–µ–Ω–∏—è, –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è)
        """
        try:
            system_prompt = self._create_system_prompt()
            
            response = await self.client.chat.completions.create(
                model="deepseek-chat",
                messages=[
                    {"role": "system", "content": system_prompt},
                    {"role": "user", "content": f"–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ: {text}"}
                ],
                temperature=0.1,  # –ù–∏–∑–∫–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
                max_tokens=500
            )
            
            # –ü–∞—Ä—Å–∏–º JSON –æ—Ç–≤–µ—Ç
            content = response.choices[0].message.content.strip()
            
            # –£–±–∏—Ä–∞–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–µ markdown –±–ª–æ–∫–∏
            if content.startswith("```json"):
                content = content[7:]
            if content.endswith("```"):
                content = content[:-3]
            
            result = json.loads(content)
            
            # –í–∞–ª–∏–¥–∏—Ä—É–µ–º –∏ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            return self._validate_result(result, text)
            
        except json.JSONDecodeError as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON –æ—Ç AI: {e}")
            return self._fallback_classification(text)
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ AI –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏: {e}")
            return self._fallback_classification(text)
    
    def _validate_result(self, result: Dict, original_text: str) -> Tuple[IntentType, Dict]:
        """–í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –∏ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç AI"""
        try:
            # –ü–æ–ª—É—á–∞–µ–º —Ç–∏–ø –Ω–∞–º–µ—Ä–µ–Ω–∏—è
            intent_str = result.get("intent", "save_info")
            intent_type = IntentType(intent_str)
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            info = {
                "original_text": original_text,
                "confidence": result.get("confidence", 0.8),
                "topic": result.get("topic", ""),
                "info_type": result.get("info_type", "general"),
                "question_type": result.get("question_type", "general"),
                "greeting_type": result.get("greeting_type", "hello")
            }
            
            return intent_type, info
            
        except ValueError:
            logger.error(f"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –Ω–∞–º–µ—Ä–µ–Ω–∏—è: {result.get('intent')}")
            return IntentType.UNKNOWN, {"original_text": original_text}
    
    def _fallback_classification(self, text: str) -> Tuple[IntentType, Dict]:
        """Fallback –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –ø—Ä–∏ –æ—à–∏–±–∫–µ AI"""
        text_lower = text.lower().strip()
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –∏ –±–µ—Å—Å–º—ã—Å–ª–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        greeting_words = ["–ø—Ä–∏–≤–µ—Ç", "–∫—É–∫—É", "—Ö–∞–π", "–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π", "–∑–¥–∞—Ä–æ–≤–∞", "—Å–∞–ª–∞–º"]
        check_presence_phrases = ["—Ç—ã —Ç—É—Ç", "—Ç—ã –∑–¥–µ—Å—å", "–º–∏—Ä–∞ —Ç—ã", "–º–∏—Ä–∞, —Ç—ã", "–ø—Ä–∏–≤–µ—Ç, –º–∏—Ä–∞", "–∫—É–∫—É, –º–∏—Ä–∞"]
        
        # –ï—Å–ª–∏ —ç—Ç–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è
        is_greeting = any(word in text_lower for word in greeting_words)
        is_check_presence = any(phrase in text_lower for phrase in check_presence_phrases)
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –±–µ—Å—Å–º—ã—Å–ª–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç (–æ—á–µ–Ω—å –∫–æ—Ä–æ—Ç–∫–∏–π –∏–ª–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –º–Ω–æ–≥–æ –Ω–µ–∞–ª—Ñ–∞–≤–∏—Ç–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤)
        text_clean = text_lower.replace(" ", "").replace(",", "").replace(".", "").replace("!", "").replace("?", "")
        is_nonsense = len(text.strip()) < 5 or (len(text.strip()) < 10 and not text_clean.isalpha())
        
        if is_greeting or is_check_presence or is_nonsense:
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
            greeting_type = "hello"
            if is_check_presence:
                greeting_type = "check_presence"
            elif is_nonsense and not is_greeting and not is_check_presence:
                greeting_type = "nonsense"
            
            return IntentType.GREETING, {
                "original_text": text,
                "greeting_type": greeting_type
            }
        
        # –ü—Ä–æ—Å—Ç–∞—è —ç–≤—Ä–∏—Å—Ç–∏–∫–∞
        if any(word in text_lower for word in ["—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", "stats"]):
            return IntentType.SHOW_STATS, {"original_text": text}
        elif any(word in text_lower for word in ["–∏–Ω—Å–∞–π—Ç—ã", "insights"]):
            return IntentType.SHOW_INSIGHTS, {"original_text": text}
        elif any(word in text_lower for word in ["–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è", "reminders"]):
            return IntentType.SHOW_REMINDERS, {"original_text": text}
        elif ("?" in text or 
              any(word in text_lower for word in ["–∫—Ç–æ", "–∫–æ–≥–æ", "–∫–æ–º—É", "–∫–µ–º", "—á—Ç–æ", "—á–µ–≥–æ", "—á–µ–º—É", "—á–µ–º", 
                                                  "–≥–¥–µ", "–∫—É–¥–∞", "–æ—Ç–∫—É–¥–∞", "–∫–æ–≥–¥–∞", "–≤–æ —Å–∫–æ–ª—å–∫–æ", "–∫–∞–∫", 
                                                  "–ø–æ—á–µ–º—É", "–∑–∞—á–µ–º", "–æ—Ç—á–µ–≥–æ", "—Å–∫–æ–ª—å–∫–æ", "–∫–∞–∫–æ–π", "–∫–∞–∫–∞—è", "–∫–∞–∫–∏–µ",
                                                  "—Ä–∞—Å—Å–∫–∞–∂–∏", "–ø–æ–∫–∞–∂–∏", "–µ—Å—Ç—å –ª–∏", "–µ—Å—Ç—å —É –º–µ–Ω—è", "–∑–Ω–∞–µ—à—å –ª–∏"])):
            return IntentType.SEARCH_INFO, {"original_text": text, "topic": text}
        else:
            return IntentType.SAVE_INFO, {"original_text": text, "info_type": "general"}
    

# –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
async def test_intent_classifier():
    """–¢–µ—Å—Ç–∏—Ä—É–µ–º AI-–∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä –Ω–∞–º–µ—Ä–µ–Ω–∏–π"""
    import os
    from dotenv import load_dotenv
    
    # –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
    load_dotenv()
    
    # –ü–æ–ª—É—á–∞–µ–º API –∫–ª—é—á –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
    api_key = os.getenv("DEEPSEEK_API_KEY")
    if not api_key:
        print("‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω DEEPSEEK_API_KEY –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è")
        return
    
    classifier = IntentClassifier(api_key)
    
    test_messages = [
        "–ö–æ–≥–æ —è –≤—Å—Ç—Ä–µ—Ç–∏–ª —Å–µ–≥–æ–¥–Ω—è?",
        "–∫–æ–≥–æ —è –≤—Å—Ç—Ä–µ—Ç–∏–ª —Å–µ–≥–æ–¥–Ω—è –∑–∞ –≤–µ—Å—å –¥–µ–Ω—å",  # –ü—Ä–æ–±–ª–µ–º–Ω—ã–π —Å–ª—É—á–∞–π –±–µ–∑ "?"
        "–ß—Ç–æ —è –∑–Ω–∞—é –æ –í–∞—Å–µ?",
        "—á—Ç–æ —è –∑–Ω–∞—é –æ –≤–∞—Å–µ",  # –ë–µ–∑ "?"
        "–°–µ–≥–æ–¥–Ω—è —è –≤—Å—Ç—Ä–µ—Ç–∏–ª –õ–∏–≤–∞–Ω–∞",
        "–í—Å—Ç—Ä–µ—Ç–∏–ª –í–∞—Å—é –≤ –∞–≤—Ç–æ—Å–µ—Ä–≤–∏—Å–µ",
        "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞",
        "–ò–Ω—Å–∞–π—Ç—ã",
        "–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è",
        "–°–∫–æ–ª—å–∫–æ —É –º–µ–Ω—è –∑–∞–ø–∏—Å–µ–π?",
        "—Å–∫–æ–ª—å–∫–æ —É –º–µ–Ω—è –∑–∞–ø–∏—Å–µ–π",  # –ë–µ–∑ "?"
        "–ü–æ–∫–∞–∂–∏ —á—Ç–æ —É –º–µ–Ω—è –µ—Å—Ç—å –ø—Ä–æ —Ä–∞–±–æ—Ç—É",
        "–ö—É–∫—É, –ú–∏—Ä–∞",  # –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
        "–¢—ã —Ç—É—Ç?",  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è
        "–ü—Ä–∏–≤–µ—Ç",  # –û–±—ã—á–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
        "–∞—ã–≤–∞—ã–≤–∞2"  # –ë–µ—Å—Å–º—ã—Å–ª–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    ]
    
    print("ü§ñ –¢–µ—Å—Ç–∏—Ä—É–µ–º AI-–∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä –Ω–∞–º–µ—Ä–µ–Ω–∏–π...")
    print("-" * 50)
    
    for message in test_messages:
        intent, info = await classifier.classify_intent(message)
        print(f"'{message}' -> {intent.value}: {info}")

if __name__ == "__main__":
    asyncio.run(test_intent_classifier())
