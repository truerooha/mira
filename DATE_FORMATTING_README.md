# Форматирование дат в ответах "расскажи"

## Описание

Реализована система человечного форматирования дат в ответах функции "расскажи". Теперь агент понимает контекст и может отвечать более естественно:

- "На прошлой неделе, 21 октября, ты встретил Дениса"
- "Вчера ты упоминал что твой вес составляет 85 кг"
- "Сегодня ты встретил Васю"
- "Завтра у тебя встреча с Георгием"

## Компоненты

### 1. `date_formatter.py` - SmartDateFormatter

Класс для форматирования дат в человечные выражения.

**Основные методы:**
- `format_entry_date(entry, reference_date)` - форматирует дату записи относительно текущей даты
- `format_entries_with_dates(entries, reference_date)` - форматирует список записей

**Примеры форматирования:**
- Сегодня → "Сегодня"
- 1 день назад → "Вчера"
- 2 дня назад → "Позавчера"
- 3-7 дней назад (та же неделя) → "В среду" (день недели)
- 8-14 дней назад → "На прошлой неделе, 25 октября"
- 2 месяца назад → "2 месяца назад, 25 октября"
- 1 год назад → "В прошлом году, 25 октября 2024"

### 2. Интеграция в `ai_response_generator.py`

Генератор ответов теперь включает человечные даты в контекст для AI:

```python
# В _format_search_data добавлено:
human_date = self.date_formatter.format_entry_date(entry)
if human_date:
    entries_text.append(f'"{human_date} {text}"')
```

### 3. Системный промпт обновлен

Добавлены инструкции для AI о правильном использовании дат:

```
ВАЖНО О ДАТАХ:
- Записи содержат человечные временные выражения (например, "Вчера", "На прошлой неделе")
- Используй эти выражения ДО текста записи
- НЕ дублируй дату, если она уже есть в начале записи
- НЕ меняй формат временных выражений на технические даты
```

## Примеры работы

### До внедрения:
```
Пользователь: "расскажи о Денисе"
Бот: "Встретил Дениса"
```

### После внедрения:
```
Пользователь: "расскажи о Денисе"
Бот: "Вчера ты встретил Дениса"
```

## Техническая реализация

1. Дата извлекается из `metadata.parsed_date` или `created_at`
2. Вычисляется разница с текущей датой
3. Форматируется в человечное выражение в зависимости от разницы
4. AI получает контекст с датой и генерирует естественный ответ

## Особенности

- **Склонения:** Дни недели правильно склоняются ("В среду", "В пятницу")
- **Множественное число:** Правильные окончания ("2 месяца назад", "5 дней назад")
- **Контекст:** Система понимает "сегодня", "вчера", "на прошлой неделе"
- **Будущее:** Поддержка напоминаний ("Завтра встреча", "Через 3 дня")

## Логика определения времени

```python
if days == 0:
    return "Сегодня"
elif days == 1:
    return "Вчера"
elif days == 2:
    return "Позавчера"
elif days <= 7 and на_этой_неделе:
    return f"В {день_недели}"
elif days <= 14:
    return f"На прошлой неделе, {дата}"
elif months == 1:
    return f"В прошлом месяце, {дата}"
elif months <= 12:
    return f"{месяцев} назад, {дата}"
elif years == 1:
    return f"В прошлом году, {дата}"
else:
    return f"{лет} назад, {дата}"
```

## Тестирование

Форматтер протестирован на разных временных интервалах:
- ✅ Сегодня
- ✅ Вчера
- ✅ Позавчера
- ✅ Неделя назад
- ✅ Месяц назад
- ✅ Год назад
- ✅ Завтра
- ✅ Через несколько дней

Интеграция проверена с реальными данными из базы.

